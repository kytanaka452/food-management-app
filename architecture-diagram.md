# システムアーキテクチャ概要

## 全体構成

```
┌─────────────────────────────────────────────────────────────┐
│                        クライアント                           │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              React (TypeScript)                      │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐    │   │
│  │  │   Pages    │  │ Components │  │   Hooks    │    │   │
│  │  └────────────┘  └────────────┘  └────────────┘    │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐    │   │
│  │  │  Contexts  │  │  Services  │  │   Utils    │    │   │
│  │  └────────────┘  └────────────┘  └────────────┘    │   │
│  └──────────────────────────────────────────────────────┘   │
│                           │                                  │
│                  Vercel (ホスティング)                       │
└───────────────────────────┼──────────────────────────────────┘
                            │
                            │ HTTPS
                            │
┌───────────────────────────▼──────────────────────────────────┐
│                      Supabase                                │
│  ┌──────────────────────────────────────────────────────┐   │
│  │                   Auth (認証)                         │   │
│  │  - ユーザー登録/ログイン                              │   │
│  │  - セッション管理                                     │   │
│  │  - JWTトークン発行                                    │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              PostgreSQL Database                     │   │
│  │  ┌────────┐  ┌──────────────┐  ┌──────────────┐    │   │
│  │  │ groups │  │group_members │  │ food_items   │    │   │
│  │  └────────┘  └──────────────┘  └──────────────┘    │   │
│  │  ┌────────┐                                          │   │
│  │  │categories                                         │   │
│  │  └────────┘                                          │   │
│  │                                                       │   │
│  │  Row Level Security (RLS) 有効                       │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │             Auto-generated APIs                      │   │
│  │  - REST API (CRUD操作)                               │   │
│  │  - Realtime API (WebSocket)                          │   │
│  └──────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────┘
```

## データフロー

### 1. 認証フロー
```
User → Login Page → AuthService → Supabase Auth
                                        │
                                        ▼
                                   JWT Token
                                        │
                                        ▼
                              AuthContext (保存)
                                        │
                                        ▼
                              以降のAPIリクエストに自動付与
```

### 2. データ取得フロー(食材一覧)
```
Dashboard → useFoodItems Hook → FoodItemService
                                      │
                                      ▼
                              Supabase Client
                                      │
                                      ▼
                              PostgreSQL (RLS チェック)
                                      │
                                      ▼
                              食材データ返却
                                      │
                                      ▼
                              State更新 → UI再レンダリング
```

### 3. リアルタイム更新フロー
```
User A                          Supabase                     User B
  │                                │                            │
  │ 食材追加                       │                            │
  ├──────────────────────>        │                            │
  │                                │                            │
  │                          INSERT実行                         │
  │                                │                            │
  │                                ├─────────────────────────>  │
  │                                │  WebSocket通知             │
  │                                │                            │
  │                                │                         State更新
  │                                │                            │
  │                                │                         UI更新
```

## セキュリティレイヤー

### Row Level Security (RLS) ポリシー
```
┌─────────────────────────────────────────────┐
│          ユーザーのリクエスト                │
└──────────────────┬──────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────┐
│          JWT認証チェック                     │
│  - トークンの有効性確認                      │
│  - ユーザーID抽出                            │
└──────────────────┬──────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────┐
│          RLSポリシー評価                     │
│                                              │
│  food_items テーブルへのSELECT:             │
│  → group_idがユーザーの所属グループか?      │
│                                              │
│  food_items テーブルへのINSERT:             │
│  → group_idがユーザーの所属グループか?      │
│                                              │
│  groups テーブルへのUPDATE:                 │
│  → ユーザーがそのグループのownerか?         │
└──────────────────┬──────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────┐
│     許可された場合のみデータアクセス         │
└─────────────────────────────────────────────┘
```

## パフォーマンス最適化

### キャッシュ戦略
```
┌──────────────────┐
│  Categories      │  → 初回ロード時のみフェッチ(変更頻度低)
│  (静的データ)    │     ローカルStateにキャッシュ
└──────────────────┘

┌──────────────────┐
│  Food Items      │  → リアルタイム監視
│  (動的データ)    │     WebSocketで自動更新
└──────────────────┘

┌──────────────────┐
│  User Groups     │  → グループ切替時のみフェッチ
│  (準静的データ)  │     AuthContextにキャッシュ
└──────────────────┘
```

### インデックス戦略
```
food_items テーブル:
  - group_id にインデックス (グループでフィルタリング)
  - expiry_date にインデックス (期限でソート)
  - category_id にインデックス (カテゴリでフィルタリング)

group_members テーブル:
  - user_id にインデックス (ユーザーのグループ検索)
  - group_id にインデックス (グループメンバー検索)
```

## スケーラビリティ考慮

### 現在の構成(Phase 1)
- 想定ユーザー数: ~1000ユーザー
- 想定グループ数: ~500グループ
- 食材データ: グループあたり~100件
- Supabase無料枠で十分対応可能

### 将来の拡張(Phase 2以降)
```
┌─────────────────┐
│  CDN (画像)     │  食材写真アップロード時
└─────────────────┘

┌─────────────────┐
│  外部API統合    │  - バーコードスキャン
│                 │  - レシピ提案(ChatGPT)
└─────────────────┘

┌─────────────────┐
│  通知サービス   │  - プッシュ通知
│                 │  - メール通知
└─────────────────┘
```

## 開発環境 vs 本番環境

### 開発環境
```
localhost:5173 (Vite Dev Server)
    │
    ▼
Supabase Development Project
```

### 本番環境
```
your-app.vercel.app
    │
    ▼
Supabase Production Project
```

**ベストプラクティス:**
- 開発用と本番用で別のSupabaseプロジェクトを使用
- 環境変数で切り替え
- マイグレーションファイルで同期
